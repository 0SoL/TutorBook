{% extends "base.html" %}
{% load static %}
{% load youtube_filter %}
{% block content %}
<link rel="stylesheet" href="{% static 'flags/sprite.css' %}">
<div>
    <div class='filter-container'>
        <h1>–ù–∞–π–¥–∏ —Å–µ–±–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —É—á–∏—Ç–µ–ª—è</h1>
        <hr>
        <form action="." method='GET'>
            <div class='filter-blocks'>
                <div class='filter-block'>
                    <label for="subject-select">–•–æ—á—É –∏–∑—É—á–∞—Ç—å</label><br>
                    <select class="js-example-basic-single" name="subject-select" id='subject-select' style="width: 200px">
                    </select>
                </div>
    
                <div class='filter-block'>
                    <label for="price-slider">–î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω</label>
                    <div id="price-slider" class="slider-styled"></div>
                    <div style="margin-top: 8px;">
                        <span id="price-slider-label"></span>
                    </div>
                    <input type="hidden" name="price_min" id="price_min">
                    <input type="hidden" name="price_max" id="price_max">
                </div>
            </div>
            <div class='button-position'>
                <button class='filter-search-button' type='submit'>–ò—Å–∫–∞—Ç—å</button>
            </div>
        </form>
    </div>
</div>
<div class='teachers-cards'>
    {% if teachers %}
        {% for teacher in teachers %}
            <div class='teacher-card-wrapper'>
                <div class='teacher-card'>
                    <div class='teacher-container'>
                        <div class='teacher-header'>
                            <div class='teacher-image'>
                                <img src="{% static teacher.avatar.url %}" alt="">
                            </div>
                            <div class='teacher-content'>
                                <div class='teacher-username'>
                                    <p>{{teacher.user.username}}</p>
                                    <i 
                                    class="{{ teacher.country_of_birth.flag_css }}" 
                                    aria-label="{{ teacher.country_of_birth.code }} —Ñ–ª–∞–≥"
                                    style="font-size:1.5em; margin-right:0.5em;"
                                    ></i>
                                </div>
                                <div class='subject'>
                                    {% for sub in teacher.subject.all %}
                                    <i class="fa-solid fa-graduation-cap"></i><p>{{ sub.name }}</p>
                                    {% empty %}
                                    <p>–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>
                                    {% endfor %}
                                </div>
                                <div class='teacher-staj'>
                                    <i class="fa-solid fa-briefcase"></i>
                                    <p>–°—Ç–∞–∂: {{teacher.work_experience}}</p>
                                </div>
                                <div class='teacher-bio-card'>
                                    {% comment %} <p id="bio-text-{{teacher.id}}" class="collapsed">{{ teacher.bio }}</p>
                                    <button class='toggle-btn' id="toggle-btn-{{teacher.id}}" style="display: none;">–ü–æ–∫–∞–∑–∞—Ç—å –±–æ–ª—å—à–µ</button> {% endcomment %}
                                    <p class="bio-text" data-full="{{ teacher.bio }}">{{ teacher.bio|truncatewords:14 }}</p>
                                    {% if teacher.bio|wordcount > 14 %}
                                        <span class="toggle-bio-btn">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class='buttons'>
                                <div class='teacher-price'>
                                    <div class="review">
                                        <div class="rating">
                                            <i class="fa-solid fa-star"></i>
                                            <span>{{ teacher.get_avg_rating|floatformat:1 }}</span>
                                        </div>
                                        <div class="review-count">
                                            <span>{{ teacher.reviews.count }} –æ—Ç–∑—ã–≤–æ–≤</span>
                                        </div>
                                    </div>                                
                                    <div class="price">
                                        <div class="price-main">
                                            <i class="fa-solid fa-money-bill"></i>
                                            <span>{{ teacher.price_per_hous }}‚Ç∏</span>
                                        </div>
                                        <div class="price-note">
                                            <span>50-–º–∏–Ω —É—Ä–æ–∫–∞</span>
                                        </div>
                                    </div>
                                </div>
                                <button class='teacher-button' id='call_modal' data-teacher-id='{{teacher.id}}'>
                                    –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                </button>
                                <a href="{% url 'start_chat' teacher.id %}">
                                    <button class='book-button'>–ù–∞–ø–∏—Å–∞—Ç—å</button>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% if teacher.video_intro %}
                <div class='video-preview'>
                    <iframe src="https://www.youtube.com/embed/{{ teacher.video_intro|youtube_id }}" frameborder="0" allowfullscreen style='border-radius: 10px;'></iframe>
                </div>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p>üòï –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º —É—á–∏—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
    {% endif %}
    </div>



{% for teacher in teachers %}
    <div class='teacher-modal-container' id='modal_container_{{teacher.id}}'>
        <div class='teacher-modal'>
            <button class='modal-close-button' data-teacher-id='{{teacher.id}}'>&times;</button>
            <div class='teacher-modal-header'>
                <h2><a href="{% url 'teacher-profile-page' teacher.user.username %}">{{teacher.user.username}}</a></h2>
            </div>
            <div class='teacher-modal-info'>
                <div class='bio-section'>
                    <h2><strong>–û–±–æ –º–Ω–µ</strong></h2>
                    <p id="bio-text-{{teacher.id}}" class="collapsed">{{ teacher.bio }}</p>
                    <button class='toggle-btn' id="toggle-btn-{{teacher.id}}" style="display: none;">–ü–æ–∫–∞–∑–∞—Ç—å –±–æ–ª—å—à–µ</button>
                </div>
            
                <!-- –ë–ª–æ–∫: –û—Ç–∑—ã–≤—ã -->
                <div class="info-section">
                    <h2>–û—Ç–∑—ã–≤—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h2>
                    <div class="stars">
                        <span class="fa fa-star checked"></span>
                        <span class="fa fa-star checked"></span>
                        <span class="fa fa-star checked"></span>
                        <span class="fa fa-star"></span>
                        <span class="fa fa-star"></span>
                    </div>
                    <p class="review">–û—á–µ–Ω—å –¥–æ—Å—Ç—É–ø–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç! ‚Äî –ê–ª–∏—è</p>
                </div>
            
                <!-- –ë–ª–æ–∫: –¶–µ–Ω–∞ -->
                <div class="price-section">
                    <p>{{ teacher.price_per_hous }}‚Ç∏</p>
                    <a href="{% url 'lesson-booking' teacher.user.username%}">
                        <button class='book-button'>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </a>
                </div>

                <div class="price-section">
                    <h2>–ì—Ä–∞—Ñ–∏–∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏</h2>
                </div>

                <div class="price-section">
                    <h2>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</h2>
                </div>

                <div class="price-section">
                    <h2>–§–æ—Ä–º–∞—Ç—ã –∑–∞–Ω—è—Ç–∏–π</h2>
                </div>

            </div>
        </div>
    </div>
{% endfor %}


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
<link rel="stylesheet" href="{% static 'style/teacher/teacher-card.css' %}">
<link rel="stylesheet" href="{% static 'style/teacher/modal-teacher.css' %}">
<script src="{% static 'js/teacher/modal-teacher.js' %}"></script>
<script>
    $(document).ready(function() {
        $('#subject-select').select2({
            ajax: {
                url: '/teacher/ajax/subjects/',
                dataType: 'json',
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                }
            }
        });
    });

    const slider = document.getElementById('price-slider');

    noUiSlider.create(slider, {
      start: [{{ request.GET.price_min|default:min_price }}, {{ request.GET.price_max|default:max_price }}],
      connect: true,
      range: {
        'min': {{ min_price }},
        'max': {{ max_price }}
      },
      step: 1,
      tooltips: true,
      format: {
        to: value => parseInt(value),
        from: value => parseInt(value)
      }
    });
  
    slider.noUiSlider.on('update', function(values, handle) {
      document.getElementById('price_min').value = values[0];
      document.getElementById('price_max').value = values[1];
    });


    document.addEventListener('DOMContentLoaded', function() {
        {% for teacher in teachers %}
            const bioText{{teacher.id}} = document.getElementById('bio-text-{{teacher.id}}');
            const toggleBtn{{teacher.id}} = document.getElementById('toggle-btn-{{teacher.id}}');
            const fullText{{teacher.id}} = bioText{{teacher.id}}.textContent;
    
            if (fullText{{teacher.id}}.length > 100) {
                toggleBtn{{teacher.id}}.style.display = 'inline';
    
                toggleBtn{{teacher.id}}.addEventListener('click', function() {
                    bioText{{teacher.id}}.classList.toggle('collapsed');
                    toggleBtn{{teacher.id}}.textContent = bioText{{teacher.id}}.classList.contains('collapsed') ? '–ü–æ–∫–∞–∑–∞—Ç—å –±–æ–ª—å—à–µ' : '–°–∫—Ä—ã—Ç—å';
                });
            }
        {% endfor %}
    });

    document.addEventListener("DOMContentLoaded", function () {
        const toggleButtons = document.querySelectorAll(".toggle-bio-btn");
    
        toggleButtons.forEach(button => {
            const bioText = button.previousElementSibling;
            const fullText = bioText.getAttribute("data-full");
            const truncated = fullText.split(" ").slice(0, 20).join(" ") + "...";
    
            let isExpanded = false;
    
            button.addEventListener("click", () => {
                if (!isExpanded) {
                    bioText.textContent = fullText;
                    button.textContent = "–°–∫—Ä—ã—Ç—å";
                    isExpanded = true;
                } else {
                    bioText.textContent = truncated;
                    button.textContent = "–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ";
                    isExpanded = false;
                }
            });
        });
    });
</script>
{% endblock content %}